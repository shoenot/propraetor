{% extends base_template %}
{% block main_extra_class %}details-page{% endblock %}

{% block title %}spare part {{ spare.component_type.type_name }}.{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<div class="detail-breadcrumb">
    <a href="{% url 'propraetor:spare_parts_list' %}">spare_parts</a>
    <span> / </span>
    <span>{{ spare.component_type.type_name }} - {{ spare.manufacturer|default:"Generic" }}</span>
</div>

<!-- Info Notice -->
<div class="info-notice info-notice-muted">
    <svg class="info-notice-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    <span>
        This is an <strong>inventory configuration entry</strong>.
        The available quantity ({{ spare.quantity_available }}) is automatically derived from
        <a href="{% url 'propraetor:components_list' %}?status=spare&q={{ spare.component_type.type_name|urlencode }}">components with status=spare</a>
        for this type and synced whenever components are created, updated, or deleted.
        Edit this entry to change reorder thresholds, notes, or storage location.
    </span>
</div>

<!-- Spare Part Header -->
<div class="detail-header">
    <div>
        <h1 class="detail-title">{{ spare.component_type.type_name }}</h1>
        <div class="detail-meta">
            {% if spare.manufacturer %}
                <span class="text-muted">{{ spare.manufacturer }}</span>
            {% endif %}
            {% if spare.model %}
                <span class="text-muted">{{ spare.model }}</span>
            {% endif %}
            {% if spare.needs_restock %}
                <span class="status-badge status-disposed">low_stock</span>
            {% else %}
                <span class="status-badge status-active">in_stock</span>
            {% endif %}
        </div>
    </div>
    <div class="detail-header-actions">
        <a href="{% url 'propraetor:spare_part_edit' spare.id %}" class="btn btn-secondary">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
            </svg>
            edit_thresholds
        </a>
        <button
            class="btn btn-secondary"
            hx-delete="{% url 'propraetor:spare_part_delete' spare.id %}"
            hx-confirm="Are you sure you want to delete this spare part inventory entry? This only removes the inventory configuration — actual spare components will not be affected." data-confirm-message="Are you sure you want to delete this spare part inventory entry? This only removes the inventory configuration — actual spare components will not be affected."
        >
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
            delete
        </button>
    </div>
</div>

<div class="detail-grid">
    <!-- Left Column -->
    <div class="detail-column">
        <!-- Part Information -->
        <section class="detail-card">
            <h2 class="detail-card-title">Part Information</h2>
            <div class="detail-card-content">
                <div class="field-group">
                    <label>component_type</label>
                    <div class="value">
                        <a href="{% url 'propraetor:component_type_details' spare.component_type.id %}" class="link">
                            {{ spare.component_type.type_name }}
                        </a>
                    </div>
                </div>

                <div class="field-group">
                    <label>manufacturer</label>
                    <div class="value">
                        {% if spare.manufacturer %}
                            {{ spare.manufacturer }}
                        {% else %}
                            <span class="text-muted">not_set</span>
                        {% endif %}
                    </div>
                </div>

                <div class="field-group">
                    <label>model</label>
                    <div class="value">
                        {% if spare.model %}
                            {{ spare.model }}
                        {% else %}
                            <span class="text-muted">not_set</span>
                        {% endif %}
                    </div>
                </div>

                {% if spare.specifications %}
                <div class="field-group">
                    <label>specifications</label>
                    <div class="value">{{ spare.specifications }}</div>
                </div>
                {% endif %}

                <div class="field-group">
                    <label>location</label>
                    <div class="value">
                        {% if spare.location %}
                            <a href="{% url 'propraetor:location_details' spare.location.id %}" class="link">
                                {{ spare.location.name }}
                            </a>
                        {% else %}
                            <span class="text-muted">not_set</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </section>

        <!-- Notes -->
        {% if spare.notes %}
        <section class="detail-card">
            <h2 class="detail-card-title">Notes</h2>
            <div class="detail-card-content">
                <div class="notes-content">
                    {{ spare.notes }}
                </div>
            </div>
        </section>
        {% endif %}

        <!-- Timeline -->
        <section class="detail-card">
            <h2 class="detail-card-title">Timeline</h2>
            <div class="detail-card-content">
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <div class="timeline-label">created_at</div>
                            <div class="timeline-value">{{ spare.created_at|date:"Y-m-d H:i" }}</div>
                        </div>
                    </div>

                    {% if spare.last_restocked %}
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <div class="timeline-label">last_restocked</div>
                            <div class="timeline-value">{{ spare.last_restocked|date:"Y-m-d" }}</div>
                        </div>
                    </div>
                    {% endif %}

                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <div class="timeline-label">last_updated</div>
                            <div class="timeline-value">{{ spare.updated_at|date:"Y-m-d H:i" }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Right Column -->
    <div class="detail-column">
        <!-- Inventory Status -->
        <section class="detail-card">
            <h2 class="detail-card-title">Inventory Status</h2>
            <div class="detail-card-content">
                <div class="field-group">
                    <label>quantity_available <span class="text-muted text-xs">(auto-synced)</span></label>
                    <div class="value fw-semibold">
                        {{ spare.quantity_available }}
                        <span class="text-muted text-xs"> &mdash; derived from
                            <a href="{% url 'propraetor:components_list' %}?status=spare&q={{ spare.component_type.type_name|urlencode }}" class="link">spare components</a>
                        </span>
                    </div>
                </div>

                <div class="field-group">
                    <label>quantity_minimum <span class="text-muted text-xs">(reorder threshold)</span></label>
                    <div class="value">{{ spare.quantity_minimum }}</div>
                </div>

                <div class="field-group">
                    <label>restock_status</label>
                    <div class="value">
                        {% if spare.needs_restock %}
                            <span class="status-badge status-disposed">needs_restock</span>
                        {% else %}
                            <span class="status-badge status-active">adequate</span>
                        {% endif %}
                    </div>
                </div>

                <div class="field-group">
                    <label>last_restocked</label>
                    <div class="value">
                        {% if spare.last_restocked %}
                            {{ spare.last_restocked|date:"Y-m-d" }}
                        {% else %}
                            <span class="text-muted">never</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </section>

        <!-- Quick Actions -->
        <section class="detail-card">
            <h2 class="detail-card-title">Quick Actions</h2>
            <div class="detail-card-content">
                <div class="action-stack">
                    <a href="{% url 'propraetor:components_list' %}?status=spare&q={{ spare.component_type.type_name|urlencode }}" class="btn btn-primary btn-action">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                        </svg>
                        view_spare_components
                    </a>
                    <a href="{% url 'propraetor:spare_part_edit' spare.id %}" class="btn btn-secondary btn-action">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        edit_thresholds_&amp;_metadata
                    </a>
                    <a href="{% url 'propraetor:component_create' %}" class="btn btn-secondary btn-action">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        add_spare_component
                    </a>
                </div>
            </div>
        </section>
    </div>
</div>

<!-- Spare Components Table (full width, below the two-column grid) -->
<section class="detail-card" style="margin-top: 1.5rem;">
    <h2 class="detail-card-title">Spare Components ({{ spare_components|length }})</h2>
    <div class="detail-card-content">
        {% if spare_components %}
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>TAG</th>
                        <th>MANUFACTURER</th>
                        <th>MODEL</th>
                        <th>SERIAL</th>
                        <th>SPECIFICATIONS</th>
                        <th>PARENT ASSET</th>
                        <th>PURCHASE DATE</th>
                    </tr>
                </thead>
                <tbody>
                    {% for comp in spare_components %}
                    <tr>
                        <td>
                            <a href="{% url 'propraetor:component_details' comp.id %}" class="link">
                                {{ comp.component_tag }}
                            </a>
                        </td>
                        <td>{{ comp.manufacturer|default:"—" }}</td>
                        <td>{{ comp.model|default:"—" }}</td>
                        <td class="text-sm text-break">{{ comp.serial_number|default:"—" }}</td>
                        <td>{{ comp.specifications|default:"—" }}</td>
                        <td>
                            {% if comp.parent_asset %}
                                <a href="{% url 'propraetor:asset_details' comp.parent_asset.id %}" class="link">
                                    {{ comp.parent_asset.asset_tag }}
                                </a>
                            {% else %}
                                <span class="text-muted">unassigned</span>
                            {% endif %}
                        </td>
                        <td>{{ comp.purchase_date|date:"Y-m-d"|default:"—" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div style="margin-top: 12px;">
            <a href="{% url 'propraetor:components_list' %}?status=spare&q={{ spare.component_type.type_name|urlencode }}" class="btn btn-secondary btn-view-all">
                view_all_in_components_list
            </a>
        </div>
        {% else %}
        <p class="text-muted">No spare components of this type currently in inventory. Stock will appear here automatically when components of type "{{ spare.component_type.type_name }}" are set to status=spare.</p>
        {% endif %}
    </div>
</section>
<br>
{% endblock %}